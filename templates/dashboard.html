<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Izistore 2026 - Dashboard de Proyecciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .kpi-card { transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-5px); }
        .sidebar {
            background: #212529;
            color: white;
            min-height: 100vh;
            padding: 20px;
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            overflow-y: auto;
        }
        .main-content {
            margin-left: 16.66667%; /* Compensa el ancho del sidebar (col-md-2) */
        }
        @media (max-width: 768px) {
            .sidebar {
                position: relative;
            }
            .main-content {
                margin-left: 0;
            }
        }
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #212529;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar / Controls -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar">
                <h4 class="mb-4">Izistore 2026</h4>

                <!-- Selector de A√±o Base -->
                <div class="mb-4">
                    <label class="form-label">A√±o Base para Proyecci√≥n</label>
                    <select class="form-select" id="yearSelect" onchange="updateProj()">
                        <option value="2025" selected>2025 (√öltimo a√±o)</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="all">Promedio de todos</option>
                    </select>
                    <small class="text-secondary">Selecciona qu√© a√±o usar como referencia para la proyecci√≥n 2026</small>
                </div>

                <hr>

                <!-- Selector de Tipo de Proyecci√≥n -->
                <div class="mb-4">
                    <label class="form-label">Tipo de Proyecci√≥n</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="projectionType" id="projTypeSales" value="sales" checked onchange="updateProj()">
                        <label class="form-check-label" for="projTypeSales">
                            üìä Crecimiento en Ventas
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="projectionType" id="projTypeProfit" value="profit" onchange="updateProj()">
                        <label class="form-check-label" for="projTypeProfit">
                            üí∞ Crecimiento en Ganancias
                        </label>
                    </div>
                    <small class="text-secondary d-block mt-2" id="projectionTypeHelp">
                        Proyecta el crecimiento en ventas totales
                    </small>
                </div>

                <hr>

                <div class="mb-4">
                    <label class="form-label" id="growthLabel">Crecimiento Ventas (%)</label>
                    <input type="range" class="form-range" id="growthRange" min="-50" max="200" value="{{ growth }}" oninput="updateProj()">
                    <span id="growthVal" class="badge bg-primary">{{ growth }}%</span>
                </div>
                <div class="mb-4">
                    <label class="form-label">ROAS Target META</label>
                    <input type="range" class="form-range" id="roasMetaRange" min="1" max="50" step="0.5" value="{{ roas_meta }}" oninput="updateProj()">
                    <span id="roasMetaVal" class="badge bg-success">{{ roas_meta }}x</span>
                    <small class="text-secondary d-block mt-1">Retorno esperado por S/ invertido en META</small>
                </div>
                <div class="mb-4">
                    <label class="form-label">ROAS Target TIKTOK</label>
                    <input type="range" class="form-range" id="roasTiktokRange" min="1" max="50" step="0.5" value="{{ roas_tiktok }}" oninput="updateProj()">
                    <span id="roasTiktokVal" class="badge bg-info">{{ roas_tiktok }}x</span>
                    <small class="text-secondary d-block mt-1">Retorno esperado por S/ invertido en TIKTOK</small>
                </div>
                <hr>
                <p class="small text-secondary">Basado en Master_Excel_2025.xlsx</p>
                <div class="d-grid gap-2 mt-auto">
                    <button class="btn btn-outline-light btn-sm" onclick="location.reload()">Refrescar Datos</button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Resumen Ejecutivo Proyectado 2026</h1>
                </div>

                <!-- Navigation Tabs -->
                <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="main-tab" data-bs-toggle="tab" data-bs-target="#main-content" type="button" role="tab" aria-controls="main-content" aria-selected="true">
                            Dashboard Principal
                        </button>
                    </li>
                    {% if ads_metrics %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ads-tab" data-bs-toggle="tab" data-bs-target="#ads-content" type="button" role="tab" aria-controls="ads-content" aria-selected="false">
                            An√°lisis de Publicidad
                        </button>
                    </li>
                    {% endif %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="custom-budget-tab" data-bs-toggle="tab" data-bs-target="#custom-budget-content" type="button" role="tab" aria-controls="custom-budget-content" aria-selected="false">
                            üí∞ Presupuesto Personalizado
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="custom-charts-tab" data-bs-toggle="tab" data-bs-target="#custom-charts-content" type="button" role="tab" aria-controls="custom-charts-content" aria-selected="false">
                            üìä Personalizados
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="dashboardTabContent">

                    <!-- TAB 1: DASHBOARD PRINCIPAL -->
                    <div class="tab-pane fade show active" id="main-content" role="tabpanel" aria-labelledby="main-tab">

                        <!-- KPIs -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card kpi-card bg-primary text-white p-3">
                                    <div class="small">Venta Anual Proyectada</div>
                                    <h3 id="totalSales">S/ {{ "{:,.2f}".format(summary.total_sales) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card kpi-card bg-success text-white p-3">
                                    <div class="small">Utilidad Neta Estimada</div>
                                    <h3 id="totalProfit">S/ {{ "{:,.2f}".format(summary.total_profit) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card kpi-card bg-warning text-dark p-3">
                                    <div class="small">Costo Mercader√≠a (COGS)</div>
                                    <h3 id="totalCogs">S/ {{ "{:,.2f}".format(summary.total_cogs) }}</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card kpi-card bg-info text-white p-3">
                                    <div class="small">Inversi√≥n Ads Total</div>
                                    <h3 id="totalAds">S/ {{ "{:,.2f}".format(summary.total_ads) }}</h3>
                                </div>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="card p-3 mb-4">
                                    <div id="yearlyChart"></div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card p-3 mb-4">
                                    <div id="yoyComparisonChart"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Top 20 Productos M√°s Rentables -->
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div id="top20Chart"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Productos "Huesos" (Baja Rotaci√≥n) -->
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div id="deadStockChart"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div id="categoryChart"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div id="historicalMonthlyChart"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div id="trendChart"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3">
                                    <div id="topProductsChart"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Comparaci√≥n A√±o a A√±o -->
                        {% if yoy_detailed_chart %}
                        <div class="row mt-4">
                            <div class="col-lg-12">
                                <h4 class="mb-3">üìä An√°lisis de Crecimiento Detallado</h4>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div id="yoyDetailedChart"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    </div>

                    <!-- TAB 2: AN√ÅLISIS DE PUBLICIDAD -->
                    {% if ads_metrics %}
                    <div class="tab-pane fade" id="ads-content" role="tabpanel" aria-labelledby="ads-tab">

                        <h3 class="mb-4">An√°lisis de Publicidad 2025</h3>

                        <!-- KPIs de Publicidad -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card kpi-card p-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <div class="small">Gasto Total en Ads</div>
                                    <h4>S/ {{ "{:,.2f}".format(ads_metrics.total_gasto) }}</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card kpi-card p-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                    <div class="small">Ventas de Publicidad</div>
                                    <h4>S/ {{ "{:,.2f}".format(ads_metrics.total_venta) }}</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card kpi-card p-3" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                    <div class="small">ROAS Promedio</div>
                                    <h4>{{ "{:.2f}".format(ads_metrics.roas_promedio) }}x</h4>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card kpi-card p-3" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                                    <div class="small">Total Registros</div>
                                    <h4>{{ ads_metrics.num_registros }}</h4>
                                </div>
                            </div>
                        </div>

                        <!-- KPIs de Atribuci√≥n -->
                        {% if ads_attribution %}
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card p-4 text-center">
                                    <div class="small text-muted mb-2">Ventas de Publicidad</div>
                                    <h3 class="text-primary mb-2">{{ "{:.1f}".format(ads_attribution.pct_ads) }}%</h3>
                                    <h5 class="text-muted">S/ {{ "{:,.0f}".format(ads_attribution.ventas_ads) }}</h5>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card p-4 text-center">
                                    <div class="small text-muted mb-2">Ventas Org√°nicas</div>
                                    <h3 class="text-success mb-2">{{ "{:.1f}".format(ads_attribution.pct_organicas) }}%</h3>
                                    <h5 class="text-muted">S/ {{ "{:,.0f}".format(ads_attribution.ventas_organicas) }}</h5>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card p-4 text-center">
                                    <div class="small text-muted mb-2">Ventas Totales</div>
                                    <h3 class="text-dark mb-2">100%</h3>
                                    <h5 class="text-muted">S/ {{ "{:,.0f}".format(ads_attribution.ventas_totales) }}</h5>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Gr√°ficos de Publicidad -->
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div id="adsSpendingChart" style="height: 400px;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <div class="card p-3 mb-4">
                                    <div class="d-flex justify-content-end mb-2">
                                        <select class="form-select form-select-sm" id="roasComparisonYear" style="width: auto;" onchange="updateRoasComparison()">
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025" selected>2025</option>
                                        </select>
                                    </div>
                                    <div id="roasComparisonChart"></div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card p-3 mb-4">
                                    <div class="d-flex justify-content-end mb-2">
                                        <select class="form-select form-select-sm" id="salesGoalYear" style="width: auto;" onchange="updateSalesGoal()">
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025" selected>2025</option>
                                            <option value="2026">2026 (Proyecci√≥n)</option>
                                        </select>
                                    </div>
                                    <div id="salesGoalChart"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Distribuci√≥n de Ventas: Ads vs Org√°nicas -->
                        <div class="row mt-4">
                            <div class="col-lg-6">
                                <div class="card p-3 mb-4">
                                    <div class="d-flex justify-content-end mb-2">
                                        <select class="form-select form-select-sm" id="attributionYear" style="width: auto;" onchange="updateAttribution()">
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025" selected>2025</option>
                                            <option value="2026">2026 (Proyecci√≥n)</option>
                                        </select>
                                    </div>
                                    <div id="attributionChart"></div>
                                </div>
                            </div>
                        </div>

                        <!-- An√°lisis Mensual de ROAS e Inversi√≥n -->
                        <h4 class="mb-3 mt-4">An√°lisis Mensual</h4>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div class="d-flex justify-content-end mb-2">
                                        <select class="form-select form-select-sm" id="monthlyRoasYear" style="width: auto;" onchange="updateMonthlyRoas()">
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025" selected>2025</option>
                                            <option value="2026">2026 (Proyecci√≥n)</option>
                                        </select>
                                    </div>
                                    <div id="monthlyRoasChart" style="height: 400px;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div class="d-flex justify-content-end mb-2">
                                        <select class="form-select form-select-sm" id="monthlySpendingYear" style="width: auto;" onchange="updateMonthlySpending()">
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025" selected>2025</option>
                                        </select>
                                    </div>
                                    <div id="monthlySpendingChart" style="height: 400px;"></div>
                                </div>
                            </div>
                        </div>

                        <h4 class="mb-3 mt-4">Proyecci√≥n de Inversi√≥n 2026</h4>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div id="monthlyProjectionChart" style="height: 400px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de Historial de Ventas y Ganancias -->
                        <h4 class="mb-3 mt-4">Historial de Ventas y Ganancias</h4>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div class="d-flex justify-content-end mb-2">
                                        <select class="form-select form-select-sm" id="salesTableYear" style="width: auto;" onchange="updateSalesTable()">
                                            <option value="all" selected>Todos los a√±os</option>
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div id="monthlySalesTable"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de Gastos en Publicidad -->
                        {% if monthly_ads_table %}
                        <h4 class="mb-3 mt-4">Gastos en Publicidad (META y TIKTOK)</h4>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="card p-3 mb-4">
                                    <div class="d-flex justify-content-end mb-2">
                                        <select class="form-select form-select-sm" id="adsTableYear" style="width: auto;" onchange="updateAdsTable()">
                                            <option value="all" selected>Todos los a√±os</option>
                                            <option value="2023">2023</option>
                                            <option value="2024">2024</option>
                                            <option value="2025">2025</option>
                                            <option value="2026">2026</option>
                                        </select>
                                    </div>
                                    <div id="monthlyAdsTable"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    </div>
                    {% endif %}

                    <!-- TAB 3: PRESUPUESTO PERSONALIZADO -->
                    <div class="tab-pane fade" id="custom-budget-content" role="tabpanel" aria-labelledby="custom-budget-tab">

                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-1">üìä Configura tu Presupuesto Mensual</h5>
                                        <p class="mb-0 small">Define cu√°nto planeas invertir cada mes en publicidad para META y TIKTOK</p>
                                    </div>
                                    <div class="card-body">
                                        <!-- Botones de plantillas r√°pidas -->
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Plantillas R√°pidas:</label>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyTemplate('uniform')">
                                                    üìä Uniforme
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-success" onclick="applyTemplate('growth')">
                                                    üìà Crecimiento
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="applyTemplate('seasonal')">
                                                    üå§Ô∏è Estacional
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-info" onclick="applyTemplate('historical')">
                                                    üìÖ Hist√≥rico
                                                </button>
                                            </div>
                                            <small class="text-muted d-block mt-1">Usa una plantilla para llenar r√°pidamente la tabla, luego ajusta manualmente</small>
                                        </div>

                                        <!-- Gesti√≥n de escenarios -->
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Gesti√≥n de Escenarios:</label>
                                            <div class="btn-group me-2" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-success" onclick="saveScenario()">
                                                    üíæ Guardar Escenario
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadScenario()">
                                                    üìÇ Cargar Escenario
                                                </button>
                                            </div>
                                            <div class="btn-group me-2" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-info" onclick="exportToCSV()">
                                                    üì§ Exportar CSV
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-warning" onclick="document.getElementById('csvFileInput').click()">
                                                    üì• Importar CSV
                                                </button>
                                                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="importFromCSV(event)">
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearTable()">
                                                üóëÔ∏è Limpiar Tabla
                                            </button>
                                            <small class="text-muted d-block mt-1">Guarda m√∫ltiples escenarios y comp√°ralos. Exporta/importa CSV para edici√≥n masiva.</small>
                                        </div>

                                        <!-- Tabla de inputs -->
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-hover" id="budgetTable">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Mes</th>
                                                        <th class="text-center">META (S/)</th>
                                                        <th class="text-center">TIKTOK (S/)</th>
                                                        <th class="text-center">Total (S/)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="budgetTableBody">
                                                    <!-- 12 filas generadas por JavaScript -->
                                                </tbody>
                                                <tfoot class="table-secondary fw-bold">
                                                    <tr>
                                                        <td>TOTAL ANUAL</td>
                                                        <td class="text-center" id="totalMetaBudget">S/ 0</td>
                                                        <td class="text-center" id="totalTiktokBudget">S/ 0</td>
                                                        <td class="text-center" id="totalBudget">S/ 0</td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>

                                        <!-- Bot√≥n calcular -->
                                        <div class="d-grid gap-2 mt-3">
                                            <button class="btn btn-primary btn-lg" id="calculateBtn" onclick="calculateCustomProjection()">
                                                üöÄ Calcular Proyecci√≥n
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Secci√≥n de resultados (oculta inicialmente) -->
                        <div id="resultsSection" style="display: none;">
                            <!-- KPIs de comparaci√≥n -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">Proyecci√≥n ROAS Tradicional</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Ventas Anuales</small>
                                                    <h4 id="roasSales" class="text-primary mb-0">-</h4>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Utilidad Neta</small>
                                                    <h4 id="roasProfit" class="text-success mb-0">-</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">Tu Presupuesto Personalizado</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Ventas Anuales</small>
                                                    <h4 id="customSales" class="text-primary mb-0">-</h4>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Utilidad Neta</small>
                                                    <h4 id="customProfit" class="text-success mb-0">-</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gr√°fico de comparaci√≥n -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">üìä Comparaci√≥n Mes a Mes</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="comparisonChart" style="height: 500px;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- An√°lisis de eficiencia -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">‚ö° An√°lisis de Eficiencia del Presupuesto</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Score de Eficiencia vs Hist√≥rico</label>
                                                <div class="progress" style="height: 30px;">
                                                    <div id="efficiencyBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                                                </div>
                                                <small class="text-muted">95-105% = √ìptimo | 85-95% o 105-120% = Aceptable | Fuera de rango = Revisar</small>
                                            </div>

                                            <!-- Alertas -->
                                            <div id="alertsSection"></div>

                                            <!-- Sugerencias -->
                                            <div id="suggestionsSection"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Custom Charts Tab -->
                    <div class="tab-pane fade" id="custom-charts-content" role="tabpanel" aria-labelledby="custom-charts-tab">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="mb-3">Gr√°ficos Hist√≥ricos Personalizados</h4>
                                <p class="text-secondary">An√°lisis hist√≥ricos y tendencias personalizadas de tu negocio.</p>
                            </div>
                        </div>

                        <!-- Gr√°fico Hist√≥rico Mensual -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">üìà Hist√≥rico Mensual de Ventas y Ganancias</h5>
                                        <small>Comparaci√≥n a√±o a a√±o (2023-2025)</small>
                                    </div>
                                    <div class="card-body">
                                        <img src="/static/historico_mensual_ventas_ganancias.png" class="img-fluid" alt="Hist√≥rico Mensual">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estad√≠sticas de Tendencia -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card text-white bg-primary">
                                    <div class="card-body">
                                        <h6 class="card-title">2023</h6>
                                        <p class="mb-1"><strong>Ventas:</strong> S/ 301,583</p>
                                        <p class="mb-0"><strong>Ganancia:</strong> S/ 170,412</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-white bg-warning">
                                    <div class="card-body">
                                        <h6 class="card-title">2024 vs 2023</h6>
                                        <p class="mb-1"><strong>Ventas:</strong> S/ 298,237 <span class="badge bg-danger">-1.1%</span></p>
                                        <p class="mb-0"><strong>Ganancia:</strong> S/ 224,569 <span class="badge bg-success">+31.8%</span></p>
                                        <hr class="my-2 bg-white">
                                        <small><em>Mejor margen de ganancia</em></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-white bg-success">
                                    <div class="card-body">
                                        <h6 class="card-title">2025 vs 2024</h6>
                                        <p class="mb-1"><strong>Ventas:</strong> S/ 336,198 <span class="badge bg-light text-dark">+12.7%</span></p>
                                        <p class="mb-0"><strong>Ganancia:</strong> S/ 264,482 <span class="badge bg-light text-dark">+17.8%</span></p>
                                        <hr class="my-2 bg-white">
                                        <small><em>Crecimiento sostenido</em></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gr√°fico de Gastos en Publicidad -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0">üí∞ Hist√≥rico de Gastos en Publicidad</h5>
                                        <small>Inversi√≥n mensual por plataforma (2023-2025)</small>
                                    </div>
                                    <div class="card-body">
                                        <img src="/static/historico_gastos_publicidad.png" class="img-fluid" alt="Hist√≥rico Gastos Publicidad">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tarjetas de Estad√≠sticas de Publicidad -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card text-white bg-primary">
                                    <div class="card-body">
                                        <h6 class="card-title">2023</h6>
                                        <p class="mb-1"><strong>Gasto Total:</strong> S/ 1,750</p>
                                        <p class="mb-0"><strong>META:</strong> 100%</p>
                                        <small><em>Solo META, sin TIKTOK</em></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-white bg-warning">
                                    <div class="card-body">
                                        <h6 class="card-title">2024 vs 2023</h6>
                                        <p class="mb-1"><strong>Gasto Total:</strong> S/ 14,732 <span class="badge bg-success">+741.8%</span></p>
                                        <p class="mb-0"><strong>META:</strong> 50.2% | <strong>TIKTOK:</strong> 49.8%</p>
                                        <hr class="my-2 bg-dark">
                                        <small><em>Inicio inversi√≥n TIKTOK</em></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card text-white bg-success">
                                    <div class="card-body">
                                        <h6 class="card-title">2025 vs 2024</h6>
                                        <p class="mb-1"><strong>Gasto Total:</strong> S/ 26,994 <span class="badge bg-light text-dark">+83.2%</span></p>
                                        <p class="mb-0"><strong>META:</strong> 95.2% | <strong>TIKTOK:</strong> 4.8%</p>
                                        <hr class="my-2 bg-white">
                                        <small><em>Enfoque en META</em></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gr√°fico TOP 10 Productos -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0">üèÜ TOP 10 Productos M√°s Vendidos 2025</h5>
                                        <small>Por monto de ventas y por cantidad vendida</small>
                                    </div>
                                    <div class="card-body">
                                        <img src="/static/top10_productos_2025.png" class="img-fluid" alt="TOP 10 Productos 2025">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estad√≠sticas TOP 10 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">üí∞ Impacto del TOP 10</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <h4 class="text-success">46.8%</h4>
                                                <small class="text-muted">de las ventas totales</small>
                                            </div>
                                            <div class="col-6">
                                                <h4 class="text-success">48.6%</h4>
                                                <small class="text-muted">de las ganancias totales</small>
                                            </div>
                                        </div>
                                        <hr>
                                        <p class="mb-0 text-center"><strong>S/ 157,371</strong> en ventas</p>
                                        <p class="mb-0 text-center"><strong>S/ 128,561</strong> en ganancias</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">üìä An√°lisis de Productos</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-2"><strong>ü•á #1 por Ventas:</strong> Pedido Web (S/ 30,305)</p>
                                        <p class="mb-2"><strong>ü•á #1 por Cantidad:</strong> Correa 22mm (1,201 unidades)</p>
                                        <hr>
                                        <p class="mb-0 small text-muted">El TOP 10 representa casi la mitad de todo el negocio, concentr√°ndose principalmente en correas para smartwatch.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gr√°fico BOTTOM 10 Productos HUESO -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-dark text-white">
                                        <h5 class="mb-0">‚ö†Ô∏è BOTTOM 10 Productos HUESO (Menor Rotaci√≥n) 2025</h5>
                                        <small>Productos con menor desempe√±o en ventas - Revisar inventario</small>
                                    </div>
                                    <div class="card-body">
                                        <img src="/static/bottom10_productos_2025.png" class="img-fluid" alt="BOTTOM 10 Productos 2025">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estad√≠sticas BOTTOM 10 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h6 class="mb-0">üìâ Impacto del BOTTOM 10</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <h4 class="text-danger">0.07%</h4>
                                                <small class="text-muted">de las ventas totales</small>
                                            </div>
                                            <div class="col-6">
                                                <h4 class="text-danger">0.06%</h4>
                                                <small class="text-muted">de las ganancias totales</small>
                                            </div>
                                        </div>
                                        <hr>
                                        <p class="mb-0 text-center"><strong>S/ 234</strong> en ventas totales</p>
                                        <p class="mb-0 text-center"><strong>S/ 146</strong> en ganancias (62.5% margen)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">üí° Recomendaciones</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul class="mb-0 small">
                                            <li><strong>LIQUIDAR:</strong> Productos con m√°rgenes bajos y poca rotaci√≥n</li>
                                            <li><strong>PROMOCIONAR:</strong> Productos con m√°rgenes altos pero poca rotaci√≥n</li>
                                            <li><strong>DESCONTINUAR:</strong> No vendidos en 3+ meses</li>
                                            <li><strong>REVISAR STOCK:</strong> No sobre-inventariar estos productos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const trendData = {{ trend_chart | safe }};
        {% if top_20_chart %}
        const top20Data = {{ top_20_chart | safe }};
        {% else %}
        const top20Data = null;
        {% endif %}
        {% if dead_stock_chart %}
        const deadStockData = {{ dead_stock_chart | safe }};
        {% else %}
        const deadStockData = null;
        {% endif %}
        const productData = {{ top_products_chart | safe }};
        const yearlyData = {{ yearly_chart | safe }};
        {% if category_chart %}
        const categoryData = {{ category_chart | safe }};
        {% else %}
        const categoryData = null;
        {% endif %}
        {% if historical_monthly_chart %}
        const historicalMonthlyData = {{ historical_monthly_chart | safe }};
        {% else %}
        const historicalMonthlyData = null;
        {% endif %}

        // Nuevos gr√°ficos de publicidad
        {% if ads_spending_chart %}
        const adsSpendingData = {{ ads_spending_chart | safe }};
        {% endif %}
        {% if roas_comparison_chart %}
        const roasComparisonData = {{ roas_comparison_chart | safe }};
        {% endif %}
        {% if sales_goal_chart %}
        const salesGoalData = {{ sales_goal_chart | safe }};
        {% endif %}
        {% if attribution_chart %}
        const attributionData = {{ attribution_chart | safe }};
        {% endif %}
        {% if monthly_roas_chart %}
        const monthlyRoasData = {{ monthly_roas_chart | safe }};
        {% endif %}
        {% if monthly_spending_chart %}
        const monthlySpendingData = {{ monthly_spending_chart | safe }};
        {% endif %}
        {% if monthly_projection_chart %}
        const monthlyProjectionData = {{ monthly_projection_chart | safe }};
        {% endif %}

        // Gr√°ficos de comparaci√≥n a√±o a a√±o
        {% if yoy_comparison_chart %}
        const yoyComparisonData = {{ yoy_comparison_chart | safe }};
        {% endif %}
        {% if yoy_detailed_chart %}
        const yoyDetailedData = {{ yoy_detailed_chart | safe }};
        {% endif %}

        // Tabla de ventas y ganancias mensuales
        {% if monthly_sales_table %}
        const monthlySalesTableData = {{ monthly_sales_table | safe }};
        {% endif %}

        // Tabla de gastos en publicidad mensuales
        {% if monthly_ads_table %}
        const monthlyAdsTableData = {{ monthly_ads_table | safe }};
        {% endif %}

        // Renderizar gr√°ficos principales
        Plotly.newPlot('trendChart', trendData.data, trendData.layout, {responsive: true});
        if (top20Data) Plotly.newPlot('top20Chart', top20Data.data, top20Data.layout, {responsive: true});
        if (deadStockData) Plotly.newPlot('deadStockChart', deadStockData.data, deadStockData.layout, {responsive: true});
        Plotly.newPlot('topProductsChart', productData.data, productData.layout, {responsive: true});
        Plotly.newPlot('yearlyChart', yearlyData.data, yearlyData.layout, {responsive: true});
        if (categoryData) Plotly.newPlot('categoryChart', categoryData.data, categoryData.layout, {responsive: true});
        if (historicalMonthlyData) Plotly.newPlot('historicalMonthlyChart', historicalMonthlyData.data, historicalMonthlyData.layout, {responsive: true});

        // Renderizar gr√°ficos de publicidad (solo si existen)
        {% if ads_spending_chart %}
        if (adsSpendingData) Plotly.newPlot('adsSpendingChart', adsSpendingData.data, adsSpendingData.layout, {responsive: true});
        {% endif %}
        {% if roas_comparison_chart %}
        if (roasComparisonData) Plotly.newPlot('roasComparisonChart', roasComparisonData.data, roasComparisonData.layout, {responsive: true});
        {% endif %}
        {% if sales_goal_chart %}
        if (salesGoalData) Plotly.newPlot('salesGoalChart', salesGoalData.data, salesGoalData.layout, {responsive: true});
        {% endif %}
        {% if attribution_chart %}
        if (attributionData) Plotly.newPlot('attributionChart', attributionData.data, attributionData.layout, {responsive: true});
        {% endif %}
        {% if monthly_roas_chart %}
        if (monthlyRoasData) Plotly.newPlot('monthlyRoasChart', monthlyRoasData.data, monthlyRoasData.layout, {responsive: true});
        {% endif %}
        {% if monthly_spending_chart %}
        if (monthlySpendingData) Plotly.newPlot('monthlySpendingChart', monthlySpendingData.data, monthlySpendingData.layout, {responsive: true});
        {% endif %}
        {% if monthly_projection_chart %}
        if (monthlyProjectionData) Plotly.newPlot('monthlyProjectionChart', monthlyProjectionData.data, monthlyProjectionData.layout, {responsive: true});
        {% endif %}

        // Renderizar tabla de ventas y ganancias mensuales
        {% if monthly_sales_table %}
        if (monthlySalesTableData) Plotly.newPlot('monthlySalesTable', monthlySalesTableData.data, monthlySalesTableData.layout, {responsive: true});
        {% endif %}

        // Renderizar tabla de gastos en publicidad
        {% if monthly_ads_table %}
        if (monthlyAdsTableData) Plotly.newPlot('monthlyAdsTable', monthlyAdsTableData.data, monthlyAdsTableData.layout, {responsive: true});
        {% endif %}

        // Renderizar gr√°ficos de comparaci√≥n a√±o a a√±o
        {% if yoy_comparison_chart %}
        if (yoyComparisonData) Plotly.newPlot('yoyComparisonChart', yoyComparisonData.data, yoyComparisonData.layout, {responsive: true});
        {% endif %}
        {% if yoy_detailed_chart %}
        if (yoyDetailedData) Plotly.newPlot('yoyDetailedChart', yoyDetailedData.data, yoyDetailedData.layout, {responsive: true});
        {% endif %}

        // Corregir problemas de ancho cuando los gr√°ficos est√°n en pesta√±as ocultas
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabEl => {
            tabEl.addEventListener('shown.bs.tab', function (event) {
                const targetId = event.target.getAttribute('data-bs-target');
                const charts = document.querySelectorAll(targetId + ' .js-plotly-plot');
                charts.forEach(chart => {
                    Plotly.Plots.resize(chart);
                });
            });
        });

        async function updateProj() {
            const growth = document.getElementById('growthRange').value;
            const roasMeta = parseFloat(document.getElementById('roasMetaRange').value);
            const roasTiktok = parseFloat(document.getElementById('roasTiktokRange').value);
            const baseYear = document.getElementById('yearSelect').value;

            // Obtener tipo de proyecci√≥n seleccionado
            const projectionType = document.querySelector('input[name="projectionType"]:checked').value;
            console.log('=== DEBUG: Projection type selected:', projectionType);

            // Actualizar etiquetas basadas en tipo de proyecci√≥n
            if (projectionType === 'profit') {
                document.getElementById('growthLabel').innerText = 'Crecimiento Ganancias (%)';
                document.getElementById('projectionTypeHelp').innerText = 'Proyecta el crecimiento en utilidad neta (ganancias)';
            } else {
                document.getElementById('growthLabel').innerText = 'Crecimiento Ventas (%)';
                document.getElementById('projectionTypeHelp').innerText = 'Proyecta el crecimiento en ventas totales';
            }

            // Actualizar badges
            document.getElementById('growthVal').innerText = growth + '%';
            document.getElementById('roasMetaVal').innerText = roasMeta + 'x';
            document.getElementById('roasTiktokVal').innerText = roasTiktok + 'x';

            // Validaci√≥n client-side
            if (roasMeta <= 0 || roasTiktok <= 0) {
                alert('ROAS debe ser mayor a 0');
                return;
            }

            const response = await fetch('/recalculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    growth: growth,
                    roas_meta: roasMeta,
                    roas_tiktok: roasTiktok,
                    base_year: baseYear,
                    projection_type: projectionType
                })
            });

            const result = await response.json();

            // Update Summary
            document.getElementById('totalSales').innerText = result.summary.total_sales;
            document.getElementById('totalProfit').innerText = result.summary.total_profit;
            document.getElementById('totalCogs').innerText = result.summary.total_cogs;
            document.getElementById('totalAds').innerText = result.summary.total_ads;

            // Update Charts
            const newTrend = JSON.parse(result.trend_chart);

            Plotly.react('trendChart', newTrend.data, newTrend.layout);
            // Los gr√°ficos Top 20 y Huesos no necesitan recalcular (son est√°ticos)

            // Update ROAS chart if present
            if (result.roas_comparison_chart) {
                const newRoas = JSON.parse(result.roas_comparison_chart);
                Plotly.react('roasComparisonChart', newRoas.data, newRoas.layout);
            }

            // Update Monthly Projection chart if present
            if (result.monthly_projection_chart) {
                const newMonthlyProj = JSON.parse(result.monthly_projection_chart);
                Plotly.react('monthlyProjectionChart', newMonthlyProj.data, newMonthlyProj.layout);
            }
        }

        // Funciones para actualizar gr√°ficos individuales por a√±o
        async function updateRoasComparison() {
            const year = document.getElementById('roasComparisonYear').value;
            const roasMeta = parseFloat(document.getElementById('roasMetaRange').value);
            const roasTiktok = parseFloat(document.getElementById('roasTiktokRange').value);

            const response = await fetch(`/api/roas_comparison/${year}?roas_meta=${roasMeta}&roas_tiktok=${roasTiktok}`);
            const result = await response.json();

            if (result.chart) {
                const chartData = JSON.parse(result.chart);
                Plotly.react('roasComparisonChart', chartData.data, chartData.layout);
            }
        }

        async function updateSalesGoal() {
            const year = document.getElementById('salesGoalYear').value;

            const response = await fetch(`/api/sales_goal/${year}`);
            const result = await response.json();

            if (result.chart) {
                const chartData = JSON.parse(result.chart);
                Plotly.react('salesGoalChart', chartData.data, chartData.layout);
            }
        }

        async function updateAttribution() {
            const year = document.getElementById('attributionYear').value;

            const response = await fetch(`/api/sales_attribution/${year}`);
            const result = await response.json();

            if (result.chart) {
                const chartData = JSON.parse(result.chart);
                Plotly.react('attributionChart', chartData.data, chartData.layout);
            }
        }

        async function updateMonthlyRoas() {
            const year = document.getElementById('monthlyRoasYear').value;

            const response = await fetch(`/api/monthly_roas/${year}`);
            const result = await response.json();

            if (result.chart) {
                const chartData = JSON.parse(result.chart);
                Plotly.react('monthlyRoasChart', chartData.data, chartData.layout);
            }
        }

        async function updateMonthlySpending() {
            const year = document.getElementById('monthlySpendingYear').value;

            const response = await fetch(`/api/monthly_spending/${year}`);
            const result = await response.json();

            if (result.chart) {
                const chartData = JSON.parse(result.chart);
                Plotly.react('monthlySpendingChart', chartData.data, chartData.layout);
            }
        }

        async function updateSalesTable() {
            const yearSelect = document.getElementById('salesTableYear').value;
            const url = yearSelect === 'all'
                ? '/api/monthly_sales_table'
                : `/api/monthly_sales_table/${yearSelect}`;

            const response = await fetch(url);
            const result = await response.json();

            if (result.chart) {
                const chartData = JSON.parse(result.chart);
                Plotly.react('monthlySalesTable', chartData.data, chartData.layout);
            }
        }

        async function updateAdsTable() {
            const yearSelect = document.getElementById('adsTableYear').value;
            const url = yearSelect === 'all'
                ? '/api/monthly_ads_table'
                : `/api/monthly_ads_table/${yearSelect}`;

            const response = await fetch(url);
            const result = await response.json();

            if (result.chart) {
                const chartData = JSON.parse(result.chart);
                Plotly.react('monthlyAdsTable', chartData.data, chartData.layout);
            }
        }

        // Bot√≥n Scroll to Top - esperar a que el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            const scrollTopBtn = document.getElementById('scrollTopBtn');

            if (scrollTopBtn) {
                // Mostrar/ocultar bot√≥n basado en scroll
                window.addEventListener('scroll', function() {
                    if (window.pageYOffset > 300) {
                        scrollTopBtn.style.display = 'flex';
                    } else {
                        scrollTopBtn.style.display = 'none';
                    }
                });

                // Scroll suave al hacer click
                scrollTopBtn.addEventListener('click', function() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }

            // ============================================================
            // FUNCIONES PARA PRESUPUESTO PERSONALIZADO
            // ============================================================

            // Inicializar tabla de presupuesto
            initBudgetTable();
        });

        // Meses en espa√±ol
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // Inicializar tabla de presupuesto
        function initBudgetTable() {
            const tbody = document.getElementById('budgetTableBody');
            if (!tbody) return; // Si no existe el elemento, salir

            tbody.innerHTML = '';

            for (let i = 1; i <= 12; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="fw-bold">${meses[i-1]}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-end"
                               id="meta_${i}" min="0" step="100" value="0"
                               oninput="updateTotals()">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-end"
                               id="tiktok_${i}" min="0" step="100" value="0"
                               oninput="updateTotals()">
                    </td>
                    <td class="text-center fw-bold" id="total_${i}">S/ 0</td>
                `;
                tbody.appendChild(row);
            }
        }

        // Actualizar totales en tiempo real
        function updateTotals() {
            let totalMeta = 0;
            let totalTiktok = 0;

            for (let i = 1; i <= 12; i++) {
                const metaVal = parseFloat(document.getElementById(`meta_${i}`).value) || 0;
                const tiktokVal = parseFloat(document.getElementById(`tiktok_${i}`).value) || 0;
                const monthTotal = metaVal + tiktokVal;

                document.getElementById(`total_${i}`).textContent = `S/ ${monthTotal.toLocaleString('es-PE', {minimumFractionDigits: 0})}`;

                totalMeta += metaVal;
                totalTiktok += tiktokVal;
            }

            document.getElementById('totalMetaBudget').textContent = `S/ ${totalMeta.toLocaleString('es-PE', {minimumFractionDigits: 0})}`;
            document.getElementById('totalTiktokBudget').textContent = `S/ ${totalTiktok.toLocaleString('es-PE', {minimumFractionDigits: 0})}`;
            document.getElementById('totalBudget').textContent = `S/ ${(totalMeta + totalTiktok).toLocaleString('es-PE', {minimumFractionDigits: 0})}`;
        }

        // Aplicar plantillas r√°pidas
        async function applyTemplate(templateType) {
            switch(templateType) {
                case 'uniform':
                    const amount = prompt('¬øQu√© monto mensual deseas para ambas plataformas?', '2000');
                    if (amount) {
                        const metaAmount = parseFloat(amount) * 0.6; // 60% META
                        const tiktokAmount = parseFloat(amount) * 0.4; // 40% TIKTOK
                        for (let i = 1; i <= 12; i++) {
                            document.getElementById(`meta_${i}`).value = metaAmount;
                            document.getElementById(`tiktok_${i}`).value = tiktokAmount;
                        }
                    }
                    break;

                case 'growth':
                    const startAmount = prompt('Monto inicial (mes 1):', '2000');
                    const growthPct = prompt('% de crecimiento mensual:', '5');
                    if (startAmount && growthPct) {
                        let current = parseFloat(startAmount);
                        const growth = parseFloat(growthPct) / 100;
                        for (let i = 1; i <= 12; i++) {
                            document.getElementById(`meta_${i}`).value = Math.round(current * 0.6);
                            document.getElementById(`tiktok_${i}`).value = Math.round(current * 0.4);
                            current = current * (1 + growth);
                        }
                    }
                    break;

                case 'seasonal':
                    // Patr√≥n estacional: bajo en ene-feb, medio mar-ago, alto sep-dic
                    const baseAmount = prompt('Monto base:', '2000');
                    if (baseAmount) {
                        const base = parseFloat(baseAmount);
                        const pattern = [0.7, 0.7, 0.9, 0.9, 1.0, 1.0, 1.0, 1.0, 1.2, 1.2, 1.4, 1.5];
                        for (let i = 1; i <= 12; i++) {
                            document.getElementById(`meta_${i}`).value = Math.round(base * pattern[i-1] * 0.6);
                            document.getElementById(`tiktok_${i}`).value = Math.round(base * pattern[i-1] * 0.4);
                        }
                    }
                    break;

                case 'historical':
                    await loadHistoricalBudgets();
                    break;
            }
            updateTotals();
        }

        // Validar inputs
        function validateBudgetInputs() {
            for (let i = 1; i <= 12; i++) {
                const metaVal = document.getElementById(`meta_${i}`).value;
                const tiktokVal = document.getElementById(`tiktok_${i}`).value;

                if (metaVal === '' || tiktokVal === '') {
                    alert(`Por favor completa todos los meses. Falta: ${meses[i-1]}`);
                    return false;
                }

                if (parseFloat(metaVal) < 0 || parseFloat(tiktokVal) < 0) {
                    alert('No se permiten valores negativos');
                    return false;
                }
            }
            return true;
        }

        // Calcular proyecci√≥n custom
        async function calculateCustomProjection() {
            if (!validateBudgetInputs()) {
                return;
            }

            // Mostrar loading
            const btn = document.getElementById('calculateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Calculando...';

            // Recopilar datos
            const monthly_budgets = {
                META: {},
                TIKTOK: {}
            };

            for (let i = 1; i <= 12; i++) {
                monthly_budgets.META[i] = parseFloat(document.getElementById(`meta_${i}`).value);
                monthly_budgets.TIKTOK[i] = parseFloat(document.getElementById(`tiktok_${i}`).value);
            }

            const baseYear = document.getElementById('yearSelect').value;

            try {
                const response = await fetch('/api/custom_budget_projection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_year: baseYear,
                        monthly_budgets: monthly_budgets
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error en el servidor');
                }

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                alert('Error al calcular proyecci√≥n: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Calcular Proyecci√≥n';
            }
        }

        // Mostrar resultados
        function displayResults(data) {
            // Mostrar secci√≥n de resultados
            document.getElementById('resultsSection').style.display = 'block';

            // Actualizar KPIs
            const summary = data.summary;
            document.getElementById('roasSales').textContent = `S/ ${summary.roas_total_sales.toLocaleString('es-PE', {minimumFractionDigits: 0})}`;
            document.getElementById('roasProfit').textContent = `S/ ${summary.roas_total_profit.toLocaleString('es-PE', {minimumFractionDigits: 0})}`;
            document.getElementById('customSales').textContent = `S/ ${summary.custom_total_sales.toLocaleString('es-PE', {minimumFractionDigits: 0})}`;
            document.getElementById('customProfit').textContent = `S/ ${summary.custom_total_profit.toLocaleString('es-PE', {minimumFractionDigits: 0})}`;

            // Renderizar gr√°fico de comparaci√≥n
            const chartData = JSON.parse(data.comparison_chart);
            Plotly.newPlot('comparisonChart', chartData.data, chartData.layout);

            // An√°lisis de eficiencia
            const efficiency = data.efficiency_analysis;
            const effBar = document.getElementById('efficiencyBar');
            effBar.style.width = `${efficiency.efficiency_score}%`;
            effBar.textContent = `${efficiency.efficiency_score.toFixed(1)}%`;

            // Color del bar seg√∫n eficiencia
            effBar.className = 'progress-bar';
            if (efficiency.efficiency_score >= 95 && efficiency.efficiency_score <= 105) {
                effBar.classList.add('bg-success');
            } else if (efficiency.efficiency_score >= 85 && efficiency.efficiency_score <= 120) {
                effBar.classList.add('bg-warning');
            } else {
                effBar.classList.add('bg-danger');
            }

            // Mostrar alertas
            const alertsDiv = document.getElementById('alertsSection');
            if (efficiency.alerts && efficiency.alerts.length > 0) {
                let alertsHtml = '<h6 class="mt-3">‚ö†Ô∏è Alertas:</h6><ul class="list-group">';
                efficiency.alerts.forEach(alert => {
                    alertsHtml += `<li class="list-group-item list-group-item-warning">
                        <strong>${alert.mes} - ${alert.platform}:</strong> ${alert.mensaje}
                    </li>`;
                });
                alertsHtml += '</ul>';
                alertsDiv.innerHTML = alertsHtml;
            } else {
                alertsDiv.innerHTML = '<p class="text-success mt-3">‚úÖ No hay alertas. Tu presupuesto est√° bien balanceado.</p>';
            }

            // Mostrar sugerencias
            const suggestionsDiv = document.getElementById('suggestionsSection');
            if (efficiency.suggestions && efficiency.suggestions.length > 0) {
                let suggestionsHtml = '<h6 class="mt-3">üí° Sugerencias:</h6><ul class="list-group">';
                efficiency.suggestions.forEach(suggestion => {
                    suggestionsHtml += `<li class="list-group-item list-group-item-info">${suggestion}</li>`;
                });
                suggestionsHtml += '</ul>';
                suggestionsDiv.innerHTML = suggestionsHtml;
            } else {
                suggestionsDiv.innerHTML = '';
            }

            // Scroll a resultados
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Re-renderizar gr√°ficos cuando se cambia de tab
        const customBudgetTab = document.getElementById('custom-budget-tab');
        if (customBudgetTab) {
            customBudgetTab.addEventListener('shown.bs.tab', function() {
                // Resize charts si existen
                if (document.getElementById('comparisonChart').children.length > 0) {
                    Plotly.Plots.resize('comparisonChart');
                }
            });
        }

        // ============================================================
        // FUNCIONES NUEVAS: GESTI√ìN DE ESCENARIOS Y DATOS
        // ============================================================

        // Cargar presupuestos hist√≥ricos reales
        async function loadHistoricalBudgets() {
            const baseYear = document.getElementById('yearSelect').value;
            const year = baseYear === 'all' ? 2025 : parseInt(baseYear);

            try {
                const response = await fetch(`/api/historical_budgets/${year}`);

                if (!response.ok) {
                    const error = await response.json();
                    alert(error.error || 'No hay datos hist√≥ricos disponibles para este a√±o');
                    return;
                }

                const data = await response.json();
                const budgets = data.budgets;

                // Llenar la tabla con los datos hist√≥ricos
                for (let i = 1; i <= 12; i++) {
                    document.getElementById(`meta_${i}`).value = budgets.META[i] || 0;
                    document.getElementById(`tiktok_${i}`).value = budgets.TIKTOK[i] || 0;
                }

                updateTotals();
                alert(`Gastos hist√≥ricos del a√±o ${data.year} cargados exitosamente.`);

            } catch (error) {
                alert('Error al cargar datos hist√≥ricos: ' + error.message);
            }
        }

        // Guardar escenario en localStorage
        function saveScenario() {
            const scenarioName = prompt('Nombre del escenario:', `Escenario ${new Date().toLocaleDateString()}`);
            if (!scenarioName) return;

            const budgets = {
                META: {},
                TIKTOK: {}
            };

            for (let i = 1; i <= 12; i++) {
                budgets.META[i] = parseFloat(document.getElementById(`meta_${i}`).value) || 0;
                budgets.TIKTOK[i] = parseFloat(document.getElementById(`tiktok_${i}`).value) || 0;
            }

            // Obtener escenarios guardados
            let scenarios = JSON.parse(localStorage.getItem('budget_scenarios') || '{}');

            scenarios[scenarioName] = {
                budgets: budgets,
                saved_at: new Date().toISOString()
            };

            localStorage.setItem('budget_scenarios', JSON.stringify(scenarios));
            alert(`Escenario "${scenarioName}" guardado exitosamente.`);
        }

        // Cargar escenario desde localStorage
        function loadScenario() {
            let scenarios = JSON.parse(localStorage.getItem('budget_scenarios') || '{}');

            if (Object.keys(scenarios).length === 0) {
                alert('No hay escenarios guardados. Guarda un escenario primero.');
                return;
            }

            // Crear lista de escenarios
            let scenarioList = 'Escenarios guardados:\n\n';
            Object.keys(scenarios).forEach((name, index) => {
                const date = new Date(scenarios[name].saved_at).toLocaleString();
                scenarioList += `${index + 1}. ${name} (${date})\n`;
            });

            const scenarioName = prompt(scenarioList + '\nIngresa el nombre del escenario a cargar:');
            if (!scenarioName) return;

            if (scenarios[scenarioName]) {
                const budgets = scenarios[scenarioName].budgets;

                for (let i = 1; i <= 12; i++) {
                    document.getElementById(`meta_${i}`).value = budgets.META[i];
                    document.getElementById(`tiktok_${i}`).value = budgets.TIKTOK[i];
                }

                updateTotals();
                alert(`Escenario "${scenarioName}" cargado exitosamente.`);
            } else {
                alert('Escenario no encontrado.');
            }
        }

        // Exportar a CSV
        function exportToCSV() {
            let csv = 'Mes,META,TIKTOK\n';

            for (let i = 1; i <= 12; i++) {
                const meta = document.getElementById(`meta_${i}`).value || 0;
                const tiktok = document.getElementById(`tiktok_${i}`).value || 0;
                csv += `${meses[i-1]},${meta},${tiktok}\n`;
            }

            // Crear blob y descargar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `presupuesto_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('CSV exportado exitosamente.');
        }

        // Importar desde CSV
        function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n');

                    // Saltar header
                    for (let i = 1; i < lines.length && i <= 12; i++) {
                        const columns = lines[i].split(',');
                        if (columns.length >= 3) {
                            const meta = parseFloat(columns[1].trim()) || 0;
                            const tiktok = parseFloat(columns[2].trim()) || 0;

                            document.getElementById(`meta_${i}`).value = meta;
                            document.getElementById(`tiktok_${i}`).value = tiktok;
                        }
                    }

                    updateTotals();
                    alert('CSV importado exitosamente.');

                } catch (error) {
                    alert('Error al importar CSV: ' + error.message);
                }
            };

            reader.readAsText(file);

            // Reset input para poder importar el mismo archivo de nuevo
            event.target.value = '';
        }

        // Limpiar tabla
        function clearTable() {
            if (!confirm('¬øEst√°s seguro de que quieres limpiar toda la tabla?')) {
                return;
            }

            for (let i = 1; i <= 12; i++) {
                document.getElementById(`meta_${i}`).value = 0;
                document.getElementById(`tiktok_${i}`).value = 0;
            }

            updateTotals();

            // Ocultar secci√≥n de resultados si est√° visible
            document.getElementById('resultsSection').style.display = 'none';
        }
    </script>

    <!-- Bot√≥n flotante Scroll to Top -->
    <button id="scrollTopBtn" style="
        display: none;
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        font-size: 48px;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    " onmouseover="this.style.transform='scale(1.1) translateY(-5px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)';"
       onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)';"
       title="Volver arriba">
        ‚Üë
    </button>

</body>
</html>
